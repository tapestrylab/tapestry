name: auto-generate changeset

on:
  pull_request:
    types: [ opened, synchronize, reopened ]
    branches:
    - main

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-changeset:
    name: generate changeset
    runs-on: ubuntu-latest

    # Skip if PR title contains [skip changeset]
    if: "!contains(github.event.pull_request.title, '[skip changeset]')"

    steps:
    - name: checkout
      uses: actions/checkout@v4
      with:
        ref: ${{ github.head_ref }}
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: configure git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    - name: setup node
      uses: actions/setup-node@v4
      with:
        node-version-file: '.nvmrc'

    - name: setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 10.19.0

    - name: check changesets
      id: check-changesets
      run: |
        # Check if this PR added new changesets (compare to base branch)
        NEW_CHANGESETS=$(git diff --diff-filter=A --name-only origin/${{ github.base_ref }}...HEAD -- .changeset/ | grep '\.md$' | grep -v 'README.md' || true)

        if [ -n "$NEW_CHANGESETS" ]; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "✓ Changesets added in this PR:"
          echo "$NEW_CHANGESETS"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "No new changesets in this PR"
        fi

    - name: generate changeset
      if: steps.check-changesets.outputs.exists == 'false'
      run: node scripts/auto-changeset.mjs

    - name: commit and push
      if: steps.check-changesets.outputs.exists == 'false'
      run: |
        if git diff --cached --quiet; then
          echo "No changeset was generated (no source changes or only docs/test/chore commits)"
          exit 0
        fi

        git commit -m "chore: add auto-generated changeset"
        git push

        echo "✓ Pushed auto-generated changeset to PR"
